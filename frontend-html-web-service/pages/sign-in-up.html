<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Register</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.12.0/dist/cdn.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="../assets/TD_web_icon.png">
    <script src="../config.js"></script>
    <style>
        .font-mali {
            font-family: 'Mali', sans-serif;
        }
    </style>
</head>
<body class="bg-[#c4bcac] min-h-screen flex items-center justify-center">
<script src="../js/script.js"></script>

<!-- Header -->
<header class="bg-[#b49c74] shadow-md w-full py-4 px-6 fixed top-0 left-0">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
        <!-- โลโก้ / ชื่อเว็บ -->
        <h1 class="text-2xl text-[#4e342e] font-bold font-mali">Tax2Ready</h1>
        <!-- เมนูหลัก (Desktop) -->
        <nav class="hidden md:flex space-x-6 relative">
            <a href="account.html" class="text-[#f7efda] font-mali hover:text-[#4e342e] hover:underline">บัญชีผู้ใช้</a>
            <a href="home.html" class="text-[#f7efda] font-mali hover:text-[#4e342e] hover:underline">เริ่มต้นเรียนรู้ใหม่</a>
            <!-- Dropdown for 'เรียนรู้เพิ่มเติม' -->
            <div class="relative group">
                <button id="learn-more-btn" class="text-[#f7efda] font-mali hover:text-[#4e342e] hover:underline focus:outline-none">
                    เรียนรู้เพิ่มเติม
                </button>
                <div id="learn-more-menu" class="absolute hidden bg-[#b49c74] mt-2 w-60 rounded-lg shadow-lg z-10 p-2">
                    <ul>
                        <li><a href="1tax-intro.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">1. ภาษีคืออะไร?</a></li>
                        <li><a href="2why-pay-tax.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">2. ทำไมเราต้องจ่ายภาษี?</a></li>
                        <li><a href="3no-tax-consequence.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">3. ไม่จ่ายภาษีจะเกิดอะไรขึ้น?</a></li>
                        <li><a href="4who-pays-tax.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">4. ใครบ้างที่ต้องเริ่มจ่ายภาษี?</a></li>
                        <li><a href="5income-tax.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">5. รายได้ที่ต้องเสียภาษี?</a></li>
                        <li><a href="6tax-deductions.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">6. สิทธิ์ลดหย่อนภาษี?</a></li>
                        <li><a href="7tax-frequency.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">7. ต้องจ่ายภาษีบ่อยแค่ไหน?</a></li>
                        <li><a href="8how-to-pay-tax.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">8. มีวิธีจ่ายภาษีอย่างไร?</a></li>
                    </ul>
                </div>
            </div>
            <a href="tax-personal.html" class="text-[#f7efda] font-mali hover:text-[#4e342e] hover:underline">คำนวณภาษี</a>
            <a href ="contact.html" class="text-[#f7efda] font-mali hover:text-[#4e342e] hover:underline">ติดต่อ</a>
        </nav>
        <!-- ปุ่ม Login (Desktop) -->
        <button type="button" onclick="location.href='sign-in-up.html'"
                class="loginButton opacity-100 hidden md:block bg-[#4e342e] text-white font-mali px-4 py-2 rounded-lg hover:bg-[#8d6e63]">Login</button>
        <!-- เมนูมือถือ (Hamburger Icon) -->
        <button class="md:hidden text-gray-600" id="mobile-menu-button">☰</button>
    </div>

    <!-- เมนูสำหรับมือถือ (ซ่อนอยู่) -->
    <nav id="mobile-menu" class="hidden md:hidden flex flex-col space-y-2 mt-3 bg-[#b49c74] p-4">
        <a href="account.html" class="text-[#f7efda] font-mali hover:text-[#4e342e] hover:underline">บัญชีผู้ใช้</a>
        <a href="home.html" class="text-[#f7efda] font-mali hover:text-[#4e342e] hover:underline">เริ่มต้นเรียนรู้ใหม่</a>
        <a href="#" id="learn-more-btn-mobile" class="text-[#f7efda] font-mali hover:text-[#4e342e] hover:underline">เรียนรู้เพิ่มเติม</a>
        <ul id="learn-more-menu-mobile" class="hidden flex-col space-y-2 bg-[#b49c74] p-2 rounded-lg">
            <li><a href="1tax-intro.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">1. ภาษีคืออะไร?</a></li>
            <li><a href="2why-pay-tax.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">2. ทำไมเราต้องจ่ายภาษี?</a></li>
            <li><a href="3no-tax-consequence.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">3. ไม่จ่ายภาษีจะเกิดอะไรขึ้น?</a></li>
            <li><a href="4who-pays-tax.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">4. ใครบ้างที่ต้องเริ่มจ่ายภาษี?</a></li>
            <li><a href="5income-tax.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">5. รายได้ที่ต้องเสียภาษี?</a></li>
            <li><a href="6tax-deductions.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">6. สิทธิ์ลดหย่อนภาษี?</a></li>
            <li><a href="7tax-frequency.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">7. ต้องจ่ายภาษีบ่อยแค่ไหน?</a></li>
            <li><a href="8how-to-pay-tax.html" class="font-mali block px-4 py-2 text-[#f7efda] hover:bg-[#8d6e63] hover:underline">8. มีวิธีจ่ายภาษีอย่างไร?</a></li>
        </ul>
        <a href="tax-personal.html" class="text-[#f7efda] font-mali hover:text-[#4e342e] hover:underline">คำนวณภาษี</a>
        <a href="contact.html" class="text-[#f7efda] font-mali hover:text-[#4e342e] hover:underline">ติดต่อ</a>
        <button type="button" onclick="location.href='sign-in-up.html'" class="loginButton opacity-100 bg-[#4e342e] text-white font-mali px-4 py-2 rounded-lg hover:bg-[#8d6e63]">Login</button>
    </nav>
</header>

<!-- Container (Login & Register) -->
<div x-data="{ isLogin: true }"
     id="main-container"
     class="w-full max-w-sm md:max-w-[1100px] h-auto md:h-[600px] p-6 flex flex-col md:flex-row justify-center items-center text-center md:text-center border border-gray-300 shadow-lg rounded-xl bg-[#ece4d4] mt-20"
     :class="isLogin ? 'md:flex-row' : 'md:flex-row-reverse'">

    <!-- ฟอร์ม Login & Register -->
    <div class="w-full md:w-1/2 p-4 border-t md:border-t-0">
        <!-- ฟอร์มเข้าสู่ระบบ -->
        <div x-show="isLogin">
            <h2 class="text-xl font-bold text-[#4e342e] font-mali">เข้าสู่ระบบ</h2>
            <form id="loginForm" class="mt-4">
                <input type="text" id="username" placeholder="ชื่อผู้ใช้ *" required
                       class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#b49c74]">
                <input type="password" id="password" placeholder="รหัสผ่าน *" required
                       class="w-full px-4 py-2 border rounded-lg mt-3 focus:outline-none focus:ring-2 focus:ring-[#b49c74]">
                <button type="submit"
                        class="w-full bg-[#4e342e] text-white font-mali px-4 py-2 mt-4 rounded-lg hover:bg-[#8d6e63]">
                    เข้าสู่ระบบ
                </button>
            </form>
            <button @click="isLogin = false"
                    class="block w-full bg-[#b49c74] text-white font-mali px-4 py-2 mt-2 rounded-lg hover:bg-[#a3885c]">
                ลงทะเบียน
            </button>
        </div>

        <!-- คุมหน้า admin -->
        <script>
            document.getElementById("loginForm").addEventListener("submit", async function(event) {
                event.preventDefault(); // Prevent default form submission

                // Get form values
                const username = document.getElementById("username").value;
                const password = document.getElementById("password").value;

                // 1. เพิ่มเงื่อนไขสำหรับบัญชี admin ก่อนที่จะส่งข้อมูลไปยัง API
                if (username === "admin" && password === "112233440") {
                    // 1.1 บันทึกสถานะ admin (สามารถใช้ localStorage เพื่อใช้ตรวจสอบสิทธิ์ในหน้าอื่น)
                    localStorage.setItem("isAdmin", "true");
                    // 1.2 เปลี่ยนหน้าไปยังหน้าบัญชี admin (ปรับแก้ URL ให้ตรงกับหน้าที่ต้องการ)
                    window.location.href = "./admin.html";
                    return;
                }

                // API URL
                const url = window.CONFIG.BASE_PATH + '/users/login';

                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ username, password })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Store JWT in localStorage
                        localStorage.setItem("jwt_token", data.token);
                        window.location.href = "./account.html"; // แก้ไข URL ให้เป็นหน้าล็อกอินของคุณ
                    } else {
                        alert("Login failed: " + (data.message || "Invalid credentials"));
                    }
                } catch (error) {
                    console.error("Error logging in:", error);
                    alert("An error occurred. Please try again.");
                }
            });
        </script>

        <!-- ฟอร์มลงทะเบียน -->
        <div x-show="!isLogin">
            <h2 class="text-xl font-bold text-[#4e342e] font-mali">ลงทะเบียน</h2>
            <form id="registerForm" class="mt-4">
                <input type="text" id="registerName" placeholder="ชื่อ *" required
                       class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-[#b49c74]">
                <input type="text" id="registerSurname" placeholder="นามสกุล *" required
                       class="w-full px-4 py-2 border rounded-lg mt-3 focus:outline-none focus:ring-2 focus:ring-[#b49c74]">
                <input type="text" id="registerUsername" placeholder="ชื่อผู้ใช้ *" required
                       class="w-full px-4 py-2 border rounded-lg mt-3 focus:outline-none focus:ring-2 focus:ring-[#b49c74]">
                <input type="password" id="registerPassword" placeholder="รหัสผ่าน *" required
                       class="w-full px-4 py-2 border rounded-lg mt-3 focus:outline-none focus:ring-2 focus:ring-[#b49c74]">
                <input type="email" id="registerEmail" placeholder="E-mail *" required
                       class="w-full px-4 py-2 border rounded-lg mt-3 focus:outline-none focus:ring-2 focus:ring-[#b49c74]">
                <input type="date" id="registerDob" required
                       class="w-full px-4 py-2 border rounded-lg mt-3 focus:outline-none focus:ring-2 focus:ring-[#b49c74]">
                <input type="tel" id="registerPhone" placeholder="เบอร์โทร *" required
                       class="w-full px-4 py-2 border rounded-lg mt-3 focus:outline-none focus:ring-2 focus:ring-[#b49c74]">
                <button type="submit"
                        class="w-full bg-[#4e342e] text-white font-mali px-4 py-2 mt-4 rounded-lg hover:bg-[#8d6e63]">
                    ลงทะเบียน
                </button>
            </form>
            <a @click="isLogin = true" href="#"
               class="block mt-2 text-[#4e342e] font-mali hover:text-[#8d6e63] hover:underline">มีบัญชีอยู่แล้ว?</a>
        </div>
    </div>

    <!-- รูปหมา (จะสลับฝั่งตาม isLogin) -->
    <div class="w-full md:w-1/2 p-4 flex justify-center">
        <img src="../assets/TD_icon.png" alt="EasyTax" class="w-70 h-70 object-cover">
    </div>

</div>
</body>
<!-- template script-->
<script>
    document.getElementById("mobile-menu-button").addEventListener("click", function () {
        document.getElementById("mobile-menu").classList.toggle("hidden");
    });

    // ทำให้เมนูมือถือแสดง / ซ่อน
    document.getElementById("mobile-menu-button").addEventListener("click", function () {
        document.getElementById("mobile-menu").classList.toggle("hidden");
    });

    // เมนูเรียนรู้เพิ่มเติม desktop
    document.getElementById("learn-more-btn").addEventListener("click", function () {
        document.getElementById("learn-more-menu").classList.toggle("hidden");
    });

    // เมนูเรียนรู้เพิ่มเติม mobile
    document.getElementById("learn-more-btn-mobile").addEventListener("click", function () {
        document.getElementById("learn-more-menu-mobile").classList.toggle("hidden");
    });

    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function (event) {
            event.preventDefault(); // ป้องกันการโหลดหน้าใหม่
            let page = this.getAttribute('data-page'); // ดึงค่า data-page
            fetch("pages/" + page)
                .then(response => response.text())
                .then(data => {
                    document.getElementById('main-container').innerHTML = data;
                })
                .catch(error => console.error('Error loading page:', error));
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const token = 'Bearer ' + localStorage.getItem('jwt_token');

        fetch(window.CONFIG.BASE_PATH+'/users/is-valid', {
            method: 'GET',
            headers: {
                'Authorization': token
            }
        })
            .then(response => {
                document.querySelectorAll('.loginButton').forEach(button => {
                    if (response.status === 200) {
                        button.classList.add('opacity-0', 'pointer-events-none');  // Make button invisible
                        button.classList.remove('opacity-100'); // Ensure it does not appear
                    } else {
                        button.classList.remove('opacity-0', 'pointer-events-none'); // Make button visible
                        button.classList.add('opacity-100');
                    }
                });
            })
            .catch(error => {
                console.error('Error:', error);
                document.querySelectorAll('.loginButton').forEach(button => {
                    button.classList.remove('opacity-0', 'pointer-events-none'); // Ensure button remains visible on error
                    button.classList.add('opacity-100');
                });
            });
    });

    // เพิ่มเงื่อนไขการตรวจสอบข้อมูลในฟอร์มลงทะเบียน
    document.getElementById("registerForm").addEventListener("submit", async function(event) {
        event.preventDefault(); // Prevent default form submission

        // Get form values (trim() เพื่อลบช่องว่างหัวท้าย)
        const name = document.getElementById("registerName").value.trim();
        const surname = document.getElementById("registerSurname").value.trim();
        const username = document.getElementById("registerUsername").value.trim();
        const email = document.getElementById("registerEmail").value.trim();
        const dob = document.getElementById("registerDob").value.trim();
        const phone = document.getElementById("registerPhone").value.trim();
        const password = document.getElementById("registerPassword").value;
        const notification_status = false; // Ensure this matches your API's expected value

        // 1 & 2. ตรวจสอบชื่อ: ห้ามมีตัวเลขหรืออักขระพิเศษ
        if (!/^[a-zA-Z\u0E00-\u0E7F\s]+$/.test(name)) {
            alert("กรุณากรอกชื่อให้ถูกต้อง");
            return;
        }

        // 3 & 4. ตรวจสอบนามสกุล: ห้ามมีตัวเลขหรืออักขระพิเศษ
        if (!/^[a-zA-Z\u0E00-\u0E7F\s]+$/.test(surname)) {
            alert("กรุณากรอกนามสกุลให้ถูกต้อง");
            return;
        }

        // 6. ตรวจสอบรูปแบบอีเมล
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert("กรุณากรอกอีเมลให้ถูกต้อง");
            return;
        }

        // 7. ตรวจสอบวันเกิด ไม่ให้เป็นวันที่ในอนาคต
        const birthDateObj = new Date(dob);
        const today = new Date();
        today.setHours(0,0,0,0);
        if (birthDateObj > today) {
            alert("กรุณากรอกวันเกิดให้ถูกต้อง");
            return;
        }

        // 12. ตรวจสอบเบอร์โทรว่ากรอกหรือไม่
        if (phone === "") {
            alert("Please fill out this field.");
            return;
        }

        // 8 & 9. ตรวจสอบเบอร์โทร: ห้ามมีตัวอักษรหรือตัวอักขระพิเศษ (ต้องมีแค่ตัวเลข)
        if (/[^0-9]/.test(phone)) {
            alert("กรุณากรอกเบอร์โทรศัพท์ให้ถูกต้อง");
            return;
        }

        // 10 & 11. ตรวจสอบความยาวของเบอร์โทร: ต้องมี 10 ตัวเท่านั้น
        if (phone.length !== 10) {
            alert("กรุณากรอกเบอร์โทรศัพท์ให้ถูกต้อง");
            return;
        }

        // 5. ตรวจสอบชื่อผู้ใช้งานซ้ำ (เรียก API ตรวจสอบชื่อผู้ใช้งาน)
        try {
            const usernameCheckUrl = window.CONFIG.BASE_PATH + '/users/check-username';
            const usernameCheckResponse = await fetch(usernameCheckUrl, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ username })
            });
            const usernameCheckData = await usernameCheckResponse.json();
            if (usernameCheckData.exists) {
                alert("ชื่อผู้ใช้งานนี้ถูกใช้แล้ว กรุณาเปลี่ยนชื่อผู้ใช้งานใหม่");
                return;
            }
        } catch (error) {
            console.error("Error checking username:", error);
            // ถ้าไม่สามารถตรวจสอบชื่อผู้ใช้งานได้ ก็อาจให้ผ่านไปหรือหยุดการสมัคร
        }

        // API URL สำหรับการลงทะเบียน
        const url = window.CONFIG.BASE_PATH + '/users/register';

        try {
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ name, surname, username, email, dob, phone, password, notification_status })
            });

            const data = await response.json();

            if (response.ok) {
                alert("ลงทะเบียนสำเร็จ: " + data.message);
                // Optionally, switch to the login view or redirect
            } else {
                alert("ลงทะเบียนไม่สำเร็จ: " + (data.error || data.message));
            }
        } catch (error) {
            console.error("Error during registration:", error);
            alert("เกิดข้อผิดพลาด กรุณาลองใหม่อีกครั้ง");
        }
    });
</script>
</html>
